import os
import json

with open("config.json", "r") as f:
	config = json.load(f)
DATADIR = config["datadir"]
PHENDIR = config["phendir"]

os.makedirs('job_reports', exist_ok=True)

# define the list of datasets that we want to make

with open(DATADIR + "/replication/data/ukb-b-idlist.txt", 'r') as f:
	DATA = f.readlines()

col=["discovery", "replication"]

DATA = [x.strip().lower() for x in DATA]


rule all:
	input: 
		expand("{DATADIR}/replication/results/{data}/{col}.statsfile.txt.gz", DATADIR = DATADIR, col=col, data=DATA)


rule create_phen:
	input:
		"{DATADIR}/replication/data/dict.rdata"
	output:
		"{DATADIR}/replication/results/{data}/phen.txt"
	shell:
		"""
Rscript make_phenotype_file.r \
{wildcards.data} \
{DATADIR}/replication/data/dict.rdata \
{PHENDIR}/data/derived/phesant_mod \
{PHENDIR}/data/linker_app15825.csv \
{DATADIR}/replication/data/discoveryids.txt \
{DATADIR}/replication/results/{wildcards.data}
		"""


rule run_gwas:
	input:
		"{DATADIR}/replication/results/{data}/phen.txt"
	output:
		"{DATADIR}/replication/results/{data}/{col}.statsfile.txt.gz"
	shell:
		"""
python run_replication.py \
--ukbbid {wildcards.data} \
--dictionaryfile {DATADIR}/replication/data/dict.rdata \
--phesantdir {PHENDIR}/data/derived/phesant_mod \
--discoveryids {DATADIR}/replication/data/discoveryids.txt \
--resultdir {DATADIR}/replication/results \
--bolt_exe_dir /mnt/storage/home/kf19639/downloads/BOLT-LMM_v2.3.4 \
--bfile /mnt/storage/private/mrcieu/research/UKBIOBANK_GWAS_Pipeline/data/bolt_bfile/grm6_european_filtered_ieu \
--bgenDir /mnt/storage/home/kf19639/repo/UKBB_replication/replication/data \
--boltSampleFile /mnt/storage/private/mrcieu/data/ukbiobank/genetic/variants/arrays/imputed/released/2018-09-18/data/dosage_bgen/data.chr1-22.sample \
--geneticMapFile /mnt/storage/home/kf19639/downloads/BOLT-LMM_v2.3.4/tables/genetic_map_hg19_withX.txt.gz \
--bgenMinMaf '0.001' \
--covarFile /mnt/storage/private/mrcieu/research/UKBIOBANK_GWAS_Pipeline/data/covariates/data.covariates_ieu.bolt.txt \
--qcovarCol '{{sex,chip}}' \
--LDscoresFile /mnt/storage/home/kf19639/downloads/BOLT-LMM_v2.3.4/tables/LDSCORE.1000G_EUR.tab.gz \
--numThreads 3 \
--modelSnps /mnt/storage/private/mrcieu/research/UKBIOBANK_GWAS_Pipeline/data/model_snps_for_grm/grm6_snps.prune.in \
--linker {PHENDIR}/data/linker_app15825.csv \
--column {wildcards.col}
		"""

