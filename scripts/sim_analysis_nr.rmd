---
title: Is sample overlap a problem in two-sample Mendelian randomisation?
author: Ildar Sadreev
output: html_document
---

```{r, echo=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, cache.lazy = FALSE)
```

```{r}
library(TwoSampleMR)
library(tidyverse)
library(RColorBrewer)
library('MRInstruments')
library(ggpubr)
my_orange = brewer.pal(n = 9, "Oranges")[4:9]
```

## The influence of sample overlap on bias in MR

Simulations were conducted to evaluate the extent to which instrument strength attenuated the bias due to sample overlap. Simulation parameters were identical to those in Burgess et al 2016 except we also included larger SNP effect sizes that will produce F statistics that are more in line with those seen in GWAS.

Simulations were conducted in two ways:

1. 20 instruments with the same simulated effect size were all used to obtain the IVW estimate (**all**)
2. Only those instruments among the 20 simulated that had p < 5e-8 were used to obtain IVW estimate (**sig**), to mimic the standard procedure used in GWAS

The simulations were conducted with different confounder effects and with causal effects of x on y 0.2. 

The replication dataset of the same size with the discovery dataset was simulated without an overlap with the discovery dataset in such a way that the outcome overlap could be any of the following:
1. Overlap with the discovery only,
2. Overlap with the replication only,
3. Overlap with both the discovery and the replication datasets.

Overall, 40 000 individuals were simulated.

## Is the weak instrument bias a problem in MR?

```{r}
# Load and prepare the data from simulations for the analysis
load("../files/results/sim_overlap_nr.rdata")
pp <- param
```



```{r}
# Functions required for plotting
# cases when overlap only with D
disc <- function(pp) {
  param <- subset(pp, offset >= 0 & offset <= 10000)
  param$overlap <- param$offset / 10000
  return(param)
}
# cases when overlap only with R
repl <- function(pp) {
  param <- subset(pp, offset >= 20000 & offset <= 30000)
  param$overlap <- 1 - (param$offset-20000) / 10000
  return(param)
}
# cases when overlap both D and R
discrepl <- function(pp) {
  param <- subset(pp, offset >= 10000 & offset <= 20000)
  param$overlap <- (param$offset-10000) / 10000
  return(param)
}
# function for plotting (q is "all" or "sig")
plotbias <- function(param,q) {
  temp <- group_by(param, nid, overlap, gx, xy, ux, uy, what) %>% summarise()
  temp$sim <- 1:nrow(temp)
  param <- inner_join(param, temp) %>% as.tibble
  # temp <- filter(param, fval11 > 9) %>% group_by(sim, f, xy, uy, overlap) %>%
  temp <- param %>% group_by(sim, gx, xy, uy, overlap, what) %>%
    summarise(
      n=sum(!is.na(b)),
      nsnp=mean(nsnp_inc),
      se=sd(b, na.rm=TRUE) / sqrt(sum(!is.na(b))),
      b=mean(b, na.rm=TRUE),
      f = mean(mean_f, na.rm=TRUE)
    )
  
  fvals <- filter(param, what=="all") %>% group_by(gx) %>% summarise(fval=round(mean(mean_f, na.rm=TRUE), 1))
  
  templ <- gather(temp, key="key", value="value", -c(gx, xy, uy, sim, n, overlap, what))
  t1 <- templ %>% filter(key == "b")
  t2 <- templ %>% filter(key == "se")
  names(t2)[names(t2) == "value"] <- "se"
  templ <- inner_join(t1, t2 %>% ungroup %>% select(sim, se), by=c("sim"))
  templ <- inner_join(templ, fvals)
  
  # Plot
  ggplot(templ %>% filter(key %in% c("b"), fval != 4.3, what %in% q), aes(x=overlap, y=value)) +
    geom_point(aes(colour=as.factor(fval), shape=what)) +
    geom_errorbar(aes(colour=as.factor(fval), linetype=what, ymin=value - se * 1.96, ymax=value + se * 1.96), width=0) +
    geom_hline(aes(yintercept=xy)) +
    geom_line(aes(colour=as.factor(fval), linetype=what)) +
    facet_grid(paste("b_xy =", xy) ~ paste("b_uy =", uy), scale="free_y") +
    scale_colour_manual(values=my_orange) +
    labs(x="Proportion sample overlap", y="Mean effect estimate", colour="Mean instrument\nF value", shape="Instrument\nselection", linetype="Instrument\nselection") +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))
}


# function for plotting (q is "all" or "sig")
plotbias1 <- function(param) {
  
  param <- subset(param,param$uy==2)
  
  temp <- group_by(param, nid, overlap, gx, xy, ux, uy, what) %>% summarise()
  temp$sim <- 1:nrow(temp)
  param <- inner_join(param, temp) %>% as.tibble
  # temp <- filter(param, fval11 > 9) %>% group_by(sim, f, xy, uy, overlap) %>%
  temp <- param %>% group_by(sim, gx, xy, uy, overlap, what) %>%
    summarise(
      n=sum(!is.na(b)),
      nsnp=mean(nsnp_inc),
      se=sd(b, na.rm=TRUE) / sqrt(sum(!is.na(b))),
      b=mean(b, na.rm=TRUE),
      f = mean(mean_f, na.rm=TRUE)
    )
  
  fvals <- filter(param, what=="all") %>% group_by(gx) %>% summarise(fval=round(mean(mean_f, na.rm=TRUE), 1))
  
  templ <- gather(temp, key="key", value="value", -c(gx, xy, uy, sim, n, overlap, what))
  t1 <- templ %>% filter(key == "b")
  t2 <- templ %>% filter(key == "se")
  names(t2)[names(t2) == "value"] <- "se"
  templ <- inner_join(t1, t2 %>% ungroup %>% select(sim, se), by=c("sim"))
  templ <- inner_join(templ, fvals)
  
  # Plot
  ggplot(templ %>% filter(key %in% c("b"), fval != 4.3), aes(x=overlap, y=value)) +
    geom_point(aes(colour=as.factor(what), shape=what)) +
    geom_errorbar(aes(colour=as.factor(what), linetype=what, ymin=value - se * 1.96, ymax=value + se * 1.96), width=0) +
    geom_hline(aes(yintercept=xy)) +
    geom_line(aes(colour=as.factor(what), linetype=what)) +
    ylim(0.1,0.6)+
    facet_grid(paste("F val =", fval) ~ paste("b_uy =", uy), scale="free_y") +
    labs(x="Proportion sample overlap", y="Mean effect estimate", colour="Instrument\nselection", shape="Instrument\nselection", linetype="Instrument\nselection") +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))
}



```





## Bias as a function of the sample overlap with the discovery dataset only

The sample overlap was calculated based on the offset with the discovery dataset (left part)

```{r}
# cases when overlap only with D
# subset the D
param <- disc(pp)
# plotting
plotbias(param,"all")
```



## Does the winner's curse make the weak instrument bias problem in MR worse?

The SNPs were filtered by the significance level (no replication)

## Bias as a function of the sample overlap with the discovery dataset only

```{r}
# cases when overlap only with D
# subset the D
param <- disc(pp)
# plotting
plotbias1(param)
```


